<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∞ Orlando Trip</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè∞</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 20px 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #1e1e2e;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid rgba(138, 106, 255, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .orlando-clock {
            font-size: 18px;
            font-weight: 600;
            margin-top: 8px;
            opacity: 0.95;
            letter-spacing: 1px;
        }

        .weekday-label {
            font-size: 10px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .next-activity-card {
            background: rgba(255,255,255,0.15);
            padding: 16px;
            border-radius: 14px;
            margin-top: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .next-activity-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .next-activity-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .next-activity-time {
            font-size: 14px;
            opacity: 0.9;
        }

        .budget-summary {
            background: rgba(30, 30, 46, 0.8);
            padding: 24px 20px;
            border-top: 1px solid rgba(138, 106, 255, 0.2);
        }

        .budget-title {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .budget-amount {
            font-size: 32px;
            font-weight: 700;
            color: #e5e7eb;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chart-container {
            margin-top: 20px;
        }

        .chart-title {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .chart-wrapper {
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pie-chart-canvas {
            width: 200px;
            height: 200px;
        }

        .legend {
            flex: 1;
            min-width: 200px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-label {
            color: #e5e7eb;
            flex: 1;
        }

        .legend-amount {
            color: #9ca3af;
            font-weight: 600;
        }

        .sync-status {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
        }

        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .action-btn {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 24px;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.add {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }

        .action-btn.add:hover {
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.5);
        }

        .action-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .day-section {
            border-bottom: 1px solid rgba(138, 106, 255, 0.1);
        }

        .day-header {
            background: rgba(99, 102, 241, 0.1);
            padding: 15px 20px;
            font-weight: bold;
            color: #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .day-header:hover {
            background: rgba(99, 102, 241, 0.15);
        }

        .day-header:active {
            background: rgba(99, 102, 241, 0.2);
        }

        .day-number {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            min-width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            padding: 0 12px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .activities {
            padding: 0;
        }

        .activity {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(138, 106, 255, 0.08);
            position: relative;
            background: rgba(30, 30, 46, 0.5);
            transition: background 0.2s;
        }

        .activity:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .activity:last-child {
            border-bottom: none;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .activity-name {
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 5px;
            font-size: 15px;
            flex: 1;
        }

        .activity-menu {
            position: relative;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            line-height: 1;
        }

        .menu-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            color: #a855f7;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: #2d2d44;
            border: 1px solid rgba(138, 106, 255, 0.3);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            min-width: 120px;
            margin-top: 4px;
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: #e5e7eb;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .menu-item:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .menu-item.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .activity-details {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.6;
        }

        .cost {
            display: inline-block;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
            color: #a78bfa;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            margin-top: 8px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .note {
            background: rgba(245, 158, 11, 0.1);
            padding: 10px 14px;
            border-radius: 10px;
            margin-top: 8px;
            font-size: 12px;
            color: #fbbf24;
            border-left: 3px solid #f59e0b;
        }

        .link {
            color: #818cf8;
            word-break: break-all;
            text-decoration: none;
            display: block;
            margin-top: 8px;
            font-size: 13px;
        }

        .link:hover {
            color: #a78bfa;
        }

        .directions-buttons {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .directions-btn {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            color: #9ca3af;
            padding: 4px 8px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid rgba(156, 163, 175, 0.2);
            background: rgba(30, 30, 46, 0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .directions-btn.google:hover {
            background: rgba(66, 133, 244, 0.1);
            color: #60a5fa;
            border-color: rgba(66, 133, 244, 0.3);
        }

        .directions-btn.waze:hover {
            background: rgba(51, 204, 255, 0.1);
            color: #38bdf8;
            border-color: rgba(51, 204, 255, 0.3);
        }

        .directions-btn:active {
            transform: scale(0.98);
        }

        .footer {
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            background: rgba(30, 30, 46, 0.5);
        }

        .collapsed .activities {
            display: none;
        }

        .arrow {
            transition: transform 0.3s;
        }

        .collapsed .arrow {
            transform: rotate(-90deg);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e1e2e;
            border-radius: 20px;
            padding: 28px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(138, 106, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
        }

        .modal-header {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 24px;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #9ca3af;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(138, 106, 255, 0.2);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: rgba(30, 30, 46, 0.8);
            color: #e5e7eb;
            transition: all 0.2s;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(30, 30, 46, 1);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.7) sepia(1) saturate(5) hue-rotate(220deg);
            cursor: pointer;
        }

        /* Dark theme for date picker calendar */
        input[type="date"]::-webkit-datetime-edit-fields-wrapper {
            color: #e5e7eb;
        }

        input[type="date"]::-webkit-datetime-edit-text {
            color: #9ca3af;
        }

        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field {
            color: #e5e7eb;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-buttons .cancel {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .modal-buttons .cancel:hover {
            background: rgba(107, 114, 128, 0.3);
            color: #e5e7eb;
        }

        .modal-buttons .save {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .modal-buttons .save:hover {
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .modal-buttons .save:disabled {
            background: rgba(107, 114, 128, 0.3);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .error-message {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 14px;
            border-radius: 0;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            animation: slideDown 0.3s ease;
        }

        .success-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 14px;
            border-radius: 0;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
        }

        .loading-spinner {
            font-size: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">‚è≥</div>
            <p style="margin-top: 15px; color: #666;">Saving to Google Sheets...</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üè∞ Orlando Trip</h1>
            <p>Panama ‚úàÔ∏è Orlando Adventure</p>
            <div class="orlando-clock" id="orlandoClock">üïê Loading...</div>
            <div class="next-activity-card" id="nextActivityCard">
                <div class="next-activity-label">üéØ Next Activity</div>
                <div class="next-activity-name" id="nextActivityName">Loading...</div>
                <div class="next-activity-time" id="nextActivityTime"></div>
            </div>
            <div class="sync-status" id="syncStatus">
                Last synced: Never
            </div>
        </div>

        <div id="errorMessage"></div>
        <div id="tripContent"></div>

        <div class="budget-summary">
            <div class="budget-title">Total Budget</div>
            <div class="budget-amount" id="totalBudget">$0.00</div>

            <div class="chart-container">
                <div class="chart-title">Spending by Category</div>
                <div class="chart-wrapper">
                    <canvas id="pieChart" class="pie-chart-canvas" width="200" height="200"></canvas>
                    <div class="legend" id="chartLegend"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="action-btn" id="refreshButton" onclick="loadFromSheets(true)">üîÑ</button>
        <button class="action-btn add" onclick="openAddModal()">‚ûï</button>
    </div>

    <!-- Add Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">‚ûï Add Expense</div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="addDate" value="2025-10-30" min="2025-10-30" max="2025-11-09" onchange="autoFillDayTitle()">
            </div>
            <div class="form-group">
                <label>Time (Orlando GMT-4)</label>
                <input type="time" id="addTime" placeholder="14:00">
                <small style="color: #9ca3af; font-size: 11px; margin-top: 4px; display: block;">
                    üí° Optional - for scheduling and Next Activity
                </small>
            </div>
            <div class="form-group">
                <label>Day Title</label>
                <input type="text" id="addDayTitle" placeholder="e.g., Arrival Day - October 30">
                <small style="color: #9ca3af; font-size: 11px; margin-top: 4px; display: block;">
                    üí° Auto-fills from existing day or leave empty to auto-generate
                </small>
            </div>
            <div class="form-group">
                <label>Activity Name</label>
                <input type="text" id="addName" placeholder="üçï Lunch at...">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="addCategory" onchange="addCategoryEmoji()">
                    <option value="">Select category...</option>
                    <option value="Parks">üé¢ Parks</option>
                    <option value="Food">üçΩÔ∏è Food</option>
                    <option value="Hotels">üè® Hotels</option>
                    <option value="Car">üöó Car</option>
                    <option value="Flights">‚úàÔ∏è Flights</option>
                    <option value="Shopping">üõçÔ∏è Shopping</option>
                    <option value="Others">‚≠ê Others</option>
                </select>
            </div>
            <div class="form-group">
                <label>Details (optional)</label>
                <textarea id="addDetails" placeholder="Location, time, etc."></textarea>
            </div>
            <div class="form-group">
                <label>Cost</label>
                <input type="text" id="addCost" placeholder="25.50">
            </div>
            <div class="form-group">
                <label>Note (optional)</label>
                <textarea id="addNote" placeholder="Any additional notes..."></textarea>
            </div>
            <div class="form-group">
                <label>Link (optional)</label>
                <input type="text" id="addLink" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Location/Address (optional)</label>
                <input type="text" id="addLocation" placeholder="123 Main St, Orlando, FL">
                <small style="color: #9ca3af; font-size: 11px; margin-top: 4px; display: block;">
                    üí° Add address for directions button
                </small>
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeAddModal()">Cancel</button>
                <button class="save" id="saveButton" onclick="saveToGoogleSheets()">Add & Sync</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        // Replace these URLs with your own:
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRqRXPlZ9rUIdzmFViPERuMfTUo0AlCd_vy9Hj-A-RoqmhGcy0--55OJnYBnxXLMV74x0n9iDg5zqvG/pub?gid=1054467242&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxFvOfZUE6WEFHnYcdbw2nvgiQ1Pw0c6r2QvFzrKcgtBkJ7wTQ-lUb1r3hEsB91K0WM/exec';

        let tripData = { days: [] };
        let lastUpdate = null;
        let lastAddedTime = null;

        function openGoogleMaps(location) {
            const encodedLocation = encodeURIComponent(location);
            const url = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
            window.open(url, '_blank');
        }

        function openWaze(location) {
            const encodedLocation = encodeURIComponent(location);
            const url = `https://waze.com/ul?q=${encodedLocation}&navigate=yes`;
            window.open(url, '_blank');
        }

        function updateOrlandoClock() {
            const orlandoTime = new Date().toLocaleString('en-US', {
                timeZone: 'America/New_York', // Orlando is GMT-4 (EDT) or GMT-5 (EST)
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });

            const clockEl = document.getElementById('orlandoClock');
            if (clockEl) {
                clockEl.textContent = 'üïê Orlando: ' + orlandoTime;
            }
        }

        function autoFillDayTitle() {
            const dateInput = document.getElementById('addDate').value;
            const dayTitleField = document.getElementById('addDayTitle');

            if (!dateInput) return;

            // Find existing day with this date
            const existingDay = tripData.days.find(d => d.dateStr === dateInput);

            if (existingDay && existingDay.dayTitle) {
                // Auto-fill with existing day title
                dayTitleField.value = existingDay.dayTitle;
                console.log('üìÖ Auto-filled day title:', existingDay.dayTitle);
            } else {
                // Clear if no existing title (let it auto-generate)
                dayTitleField.value = '';
            }
        }

        function addCategoryEmoji() {
            const categoryInput = document.getElementById('addCategory').value;
            const nameField = document.getElementById('addName');
            const currentName = nameField.value.trim();

            if (!categoryInput || !currentName) return;

            // Category emoji mapping
            const categoryEmojis = {
                'Parks': 'üé¢',
                'Food': 'üçΩÔ∏è',
                'Hotels': 'üè®',
                'Car': 'üöó',
                'Flights': '‚úàÔ∏è',
                'Shopping': 'üõçÔ∏è',
                'Others': '‚≠ê'
            };

            const emoji = categoryEmojis[categoryInput] || '‚≠ê';

            // Check if name already starts with an emoji (broader regex to catch all emojis)
            const emojiRegex = /^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F900}-\u{1F9FF}]/u;
            const startsWithEmoji = emojiRegex.test(currentName);

            if (!startsWithEmoji) {
                // Add category emoji at the beginning
                nameField.value = emoji + ' ' + currentName;
                console.log('‚ú® Added category emoji:', emoji);
            } else {
                console.log('‚úÖ Activity name already has emoji');
            }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const data = { days: {} };

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const fields = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                fields.push(current.trim());

                // Now CSV has: Date, DayNumber, DayTitle, ActivityName, ActivityDetails, Cost, Note, Link, Category, Location, Time
                const [dateStr, dayNumber, dayTitle, activityName, activityDetails, cost, note, link, category, location, time] = fields;

                if (!dayNumber || !dateStr) continue;

                // Parse the actual date from CSV
                const parsedDate = new Date(dateStr + 'T12:00:00');
                const dateKey = dateStr; // Use date as unique key instead of dayNumber

                if (!data.days[dateKey]) {
                    data.days[dateKey] = {
                        dayNumber: dayNumber,
                        dayTitle: dayTitle || dayNumber,
                        date: parsedDate,
                        dateStr: dateStr,
                        sortKey: parsedDate.getTime(),
                        activities: []
                    };
                }

                if (activityName) {
                    data.days[dateKey].activities.push({
                        name: activityName,
                        details: activityDetails || '',
                        cost: cost || '',
                        note: note || '',
                        link: link || '',
                        category: category || 'Others',
                        location: location || '',
                        time: time || ''
                    });
                }
            }

            // Sort days by date
            const sortedDays = Object.values(data.days).sort((a, b) => a.sortKey - b.sortKey);

            return { days: sortedDays };
        }

        async function loadFromSheets(forceRefresh = false) {
            const button = document.getElementById('refreshButton');
            const errorDiv = document.getElementById('errorMessage');

            // Skip auto-refresh if item was added in the last 60 seconds
            // (CSV takes time to publish, don't overwrite fresh additions)
            if (!forceRefresh && lastAddedTime) {
                const timeSinceAdd = (Date.now() - lastAddedTime) / 1000;
                if (timeSinceAdd < 60) {
                    console.log('‚è≠Ô∏è Skipping auto-refresh (item added ' + Math.floor(timeSinceAdd) + 's ago)');
                    return;
                }
            }

            button.classList.add('loading');
            errorDiv.innerHTML = '';

            try {
                // Add cache-busting parameter
                const cacheBuster = '&_=' + Date.now();
                const response = await fetch(SHEET_CSV_URL + cacheBuster);
                if (!response.ok) throw new Error('Failed to load data');

                const csvData = await response.text();
                const newData = parseCSV(csvData);

                // Update trip data
                tripData = newData;
                lastUpdate = new Date();

                render();
                updateSyncStatus();

                // Save to cache
                localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));
                localStorage.setItem('orlandoTripLastUpdate', lastUpdate.toISOString());

                // Show success feedback for manual refreshes
                if (forceRefresh) {
                    errorDiv.innerHTML = '<div class="success-message">‚úÖ Synced with Google Sheets!</div>';
                    setTimeout(() => {
                        errorDiv.innerHTML = '';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error loading from sheets:', error);

                const cached = localStorage.getItem('orlandoTripCache');
                if (cached) {
                    tripData = JSON.parse(cached);
                    const cachedUpdate = localStorage.getItem('orlandoTripLastUpdate');
                    lastUpdate = cachedUpdate ? new Date(cachedUpdate) : null;
                    render();
                    updateSyncStatus();
                    errorDiv.innerHTML = '<div class="error-message">üì° Offline - showing cached data</div>';
                } else {
                    errorDiv.innerHTML = '<div class="error-message">‚ùå Could not load data</div>';
                }
            } finally {
                button.classList.remove('loading');
            }
        }

        function calculateTotal() {
            let total = 0;
            tripData.days.forEach(day => {
                day.activities.forEach(activity => {
                    if (activity.cost) {
                        // Remove any non-numeric characters except decimal point
                        const cleanCost = String(activity.cost).replace(/[^0-9.]/g, '');
                        const costNum = parseFloat(cleanCost);
                        if (!isNaN(costNum) && costNum > 0) {
                            total += costNum;
                        }
                    }
                });
            });
            return total;
        }

        function updateTotal() {
            const total = calculateTotal();
            document.getElementById('totalBudget').innerHTML = `$${total.toFixed(2)}`;
        }

        function getCategoryTotals() {
            const categoryColors = {
                'Parks': '#8b5cf6',
                'Food': '#f59e0b',
                'Hotels': '#10b981',
                'Car': '#3b82f6',
                'Flights': '#ef4444',
                'Shopping': '#ec4899',
                'Others': '#6b7280'
            };

            const totals = {};

            tripData.days.forEach(day => {
                day.activities.forEach(activity => {
                    const category = activity.category || 'Others';
                    if (activity.cost) {
                        const cleanCost = String(activity.cost).replace(/[^0-9.]/g, '');
                        const costNum = parseFloat(cleanCost);
                        if (!isNaN(costNum) && costNum > 0) {
                            totals[category] = (totals[category] || 0) + costNum;
                        }
                    }
                });
            });

            return Object.entries(totals)
                .map(([category, amount]) => ({
                    category,
                    amount,
                    color: categoryColors[category] || '#6b7280'
                }))
                .sort((a, b) => b.amount - a.amount);
        }

        function drawPieChart() {
            const canvas = document.getElementById('pieChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const categoryData = getCategoryTotals();

            if (categoryData.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const total = categoryData.reduce((sum, item) => sum + item.amount, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;

            let startAngle = -Math.PI / 2;

            categoryData.forEach(item => {
                const sliceAngle = (item.amount / total) * 2 * Math.PI;

                // Draw slice
                ctx.fillStyle = item.color;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();

                // Add subtle border
                ctx.strokeStyle = '#1e1e2e';
                ctx.lineWidth = 2;
                ctx.stroke();

                startAngle += sliceAngle;
            });

            // Update legend
            const legendHTML = categoryData.map(item => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${item.color}"></div>
                    <div class="legend-label">${item.category}</div>
                    <div class="legend-amount">$${item.amount.toFixed(2)}</div>
                </div>
            `).join('');

            document.getElementById('chartLegend').innerHTML = legendHTML;
        }

        function updateNextActivity() {
            // Get current Orlando time (GMT-4)
            const now = new Date();
            const orlandoNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const nowStr = orlandoNow.toISOString().split('T')[0];
            const nowTime = orlandoNow.toTimeString().slice(0, 5); // HH:MM format

            let nextActivity = null;

            // Find next activity based on date AND time
            for (const day of tripData.days) {
                if (day.dateStr > nowStr || (day.dateStr === nowStr && day.activities.length > 0)) {
                    // Sort activities by time
                    const sortedActivities = [...day.activities].sort((a, b) => {
                        if (!a.time && !b.time) return 0;
                        if (!a.time) return 1;
                        if (!b.time) return -1;
                        return a.time.localeCompare(b.time);
                    });

                    // If it's today, find the next activity by time
                    if (day.dateStr === nowStr) {
                        const futureActivity = sortedActivities.find(act => act.time && act.time > nowTime);
                        if (futureActivity) {
                            nextActivity = {
                                name: futureActivity.name,
                                time: futureActivity.time,
                                dateStr: day.dateStr,
                                dayTitle: day.dayTitle
                            };
                            break;
                        }
                    } else {
                        // Future day - take first activity
                        nextActivity = {
                            name: sortedActivities[0].name,
                            time: sortedActivities[0].time,
                            dateStr: day.dateStr,
                            dayTitle: day.dayTitle
                        };
                        break;
                    }
                }
            }

            if (nextActivity) {
                document.getElementById('nextActivityName').textContent = nextActivity.name;
                const isToday = nextActivity.dateStr === nowStr;

                let dateLabel;
                if (isToday) {
                    dateLabel = 'Today';
                } else {
                    const dateObj = new Date(nextActivity.dateStr + 'T12:00:00');
                    dateLabel = dateObj.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                }

                const timeStr = nextActivity.time ? ` at ${nextActivity.time}` : '';
                document.getElementById('nextActivityTime').textContent = `${dateLabel}${timeStr}`;
            } else {
                document.getElementById('nextActivityName').textContent = 'All activities completed! üéâ';
                document.getElementById('nextActivityTime').textContent = 'Enjoy your memories!';
            }
        }

        function updateSyncStatus() {
            const statusDiv = document.getElementById('syncStatus');
            if (lastUpdate) {
                const now = new Date();
                const diff = Math.floor((now - lastUpdate) / 1000);

                if (diff < 60) {
                    statusDiv.textContent = 'Last synced: Just now';
                } else if (diff < 3600) {
                    statusDiv.textContent = `Last synced: ${Math.floor(diff / 60)} min ago`;
                } else {
                    statusDiv.textContent = `Last synced: ${lastUpdate.toLocaleTimeString()}`;
                }
            }
        }

        function toggleDay(dayIndex) {
            const daySection = document.querySelector(`.day-section[data-day="${dayIndex}"]`);
            daySection.classList.toggle('collapsed');
        }

        function toggleMenu(menuId, event) {
            event.stopPropagation();
            const menu = document.getElementById(menuId);

            // Close all other menus
            document.querySelectorAll('.menu-dropdown.active').forEach(m => {
                if (m.id !== menuId) m.classList.remove('active');
            });

            menu.classList.toggle('active');
        }

        function editActivity(dayIndex, activityIndex) {
            const day = tripData.days[dayIndex];
            const activity = day.activities[activityIndex];

            // Populate the form with existing data
            document.getElementById('addDate').value = day.dateStr;
            document.getElementById('addTime').value = activity.time || '';
            document.getElementById('addDayTitle').value = day.dayTitle || '';
            document.getElementById('addName').value = activity.name;
            document.getElementById('addCategory').value = activity.category || '';
            document.getElementById('addDetails').value = activity.details || '';
            document.getElementById('addCost').value = activity.cost || '';
            document.getElementById('addNote').value = activity.note || '';
            document.getElementById('addLink').value = activity.link || '';
            document.getElementById('addLocation').value = activity.location || '';

            // Store the edit info for later
            window.editingActivity = { dayIndex, activityIndex };

            // Change modal title and button text
            document.querySelector('.modal-header').innerHTML = '‚úèÔ∏è Edit Expense';
            document.getElementById('saveButton').textContent = 'Update & Sync';

            // Open modal
            document.getElementById('addModal').classList.add('active');

            // Close menu
            closeAllMenus();
        }

        function deleteActivity(dayIndex, activityIndex) {
            const day = tripData.days[dayIndex];
            const activity = day.activities[activityIndex];

            if (confirm(`Delete "${activity.name}"?`)) {
                // Close menu first
                closeAllMenus();

                // Remove from local data
                tripData.days[dayIndex].activities.splice(activityIndex, 1);

                // If day has no activities, remove the day
                if (tripData.days[dayIndex].activities.length === 0) {
                    tripData.days.splice(dayIndex, 1);
                }

                // Update cache
                localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));

                // Re-render
                render();

                // Show success message
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.innerHTML = '<div class="success-message">‚úÖ Deleted! (Local only - refresh to sync)</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
            } else {
                closeAllMenus();
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.menu-dropdown.active').forEach(m => {
                m.classList.remove('active');
            });
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.activity-menu')) {
                closeAllMenus();
            }
        });

        function render() {
            const content = document.getElementById('tripContent');
            content.innerHTML = '';

            if (!tripData.days || tripData.days.length === 0) {
                content.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No trip data available</div>';
                return;
            }

            // Get today's date (in same timezone)
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD

            tripData.days.forEach((day, dayIndex) => {
                const daySection = document.createElement('div');
                daySection.className = 'day-section';
                daySection.setAttribute('data-day', dayIndex);

                // Collapse by default, except if it's today
                const isToday = day.dateStr === todayStr;
                if (!isToday) {
                    daySection.classList.add('collapsed');
                }

                let activitiesHTML = '';
                day.activities.forEach((activity, activityIndex) => {
                    // Format cost safely
                    let costHTML = '';
                    if (activity.cost) {
                        const cleanCost = String(activity.cost).replace(/[^0-9.]/g, '');
                        const costNum = parseFloat(cleanCost);
                        if (!isNaN(costNum) && costNum > 0) {
                            costHTML = `<div class="cost">$${costNum.toFixed(2)}</div>`;
                        }
                    }

                    const menuId = `menu-${dayIndex}-${activityIndex}`;

                    // Create directions buttons if location exists
                    let directionsHTML = '';
                    if (activity.location) {
                        const escapedLocation = activity.location.replace(/'/g, "\\'");
                        directionsHTML = `
                            <div class="directions-buttons">
                                <button class="directions-btn google" onclick="openGoogleMaps('${escapedLocation}')">
                                    üìç Maps
                                </button>
                                <button class="directions-btn waze" onclick="openWaze('${escapedLocation}')">
                                    üöó Waze
                                </button>
                            </div>
                        `;
                    }

                    // Format time if available
                    let timeHTML = '';
                    if (activity.time) {
                        timeHTML = `<div style="font-size: 12px; color: #a78bfa; margin-top: 4px; font-weight: 600;">üïê ${activity.time}</div>`;
                    }

                    activitiesHTML += `
                        <div class="activity" data-day="${dayIndex}" data-activity="${activityIndex}">
                            <div class="activity-header">
                                <div class="activity-name">${activity.name}</div>
                                <div class="activity-menu">
                                    <button class="menu-btn" onclick="toggleMenu('${menuId}', event)">‚ãÆ</button>
                                    <div class="menu-dropdown" id="${menuId}">
                                        <div class="menu-item" onclick="editActivity(${dayIndex}, ${activityIndex})">
                                            ‚úèÔ∏è Edit
                                        </div>
                                        <div class="menu-item delete" onclick="deleteActivity(${dayIndex}, ${activityIndex})">
                                            üóëÔ∏è Delete
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ${timeHTML}
                            ${activity.details ? `<div class="activity-details">${activity.details}</div>` : ''}
                            ${costHTML}
                            ${activity.note ? `<div class="note">${activity.note}</div>` : ''}
                            ${activity.link ? `<a href="${activity.link}" class="link" target="_blank">Link ‚Üí</a>` : ''}
                            ${directionsHTML}
                        </div>
                    `;
                });

                // Get weekday
                const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const weekday = weekdays[day.date.getDay()];

                daySection.innerHTML = `
                    <div class="day-header" onclick="toggleDay(${dayIndex})">
                        <div class="day-number">
                            ${day.dayNumber}
                            <div class="weekday-label">${weekday}</div>
                        </div>
                        <span style="flex: 1; margin-left: 15px;">${day.dayTitle}${isToday ? ' üìç' : ''}</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="activities">
                        ${activitiesHTML}
                    </div>
                `;

                content.appendChild(daySection);
            });

            updateTotal();
            drawPieChart();
            updateNextActivity();
        }

        function openAddModal() {
            // Reset editing state
            window.editingActivity = null;

            // Reset modal title and button
            document.querySelector('.modal-header').innerHTML = '‚ûï Add Expense';
            document.getElementById('saveButton').textContent = 'Add & Sync';

            // Set default date to today or first trip date
            const today = new Date();
            const tripStart = new Date(2025, 9, 30); // Oct 30, 2025
            const tripEnd = new Date(2025, 10, 9);   // Nov 9, 2025

            let defaultDate = today;
            if (today < tripStart) defaultDate = tripStart;
            if (today > tripEnd) defaultDate = tripStart;

            const dateStr = defaultDate.toISOString().split('T')[0];
            document.getElementById('addDate').value = dateStr;

            // Clear all fields
            document.getElementById('addTime').value = '';
            document.getElementById('addDayTitle').value = '';
            document.getElementById('addName').value = '';
            document.getElementById('addCategory').value = '';
            document.getElementById('addDetails').value = '';
            document.getElementById('addCost').value = '';
            document.getElementById('addNote').value = '';
            document.getElementById('addLink').value = '';
            document.getElementById('addLocation').value = '';

            // Auto-fill day title for the default date
            autoFillDayTitle();

            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            window.editingActivity = null;

            // Reset modal title and button
            document.querySelector('.modal-header').innerHTML = '‚ûï Add Expense';
            document.getElementById('saveButton').textContent = 'Add & Sync';
        }

        function addItemToLocalData(data) {
            // Find or create the day in local data using dateStr
            let dayData = tripData.days.find(d => d.dateStr === data.dateStr);

            if (!dayData) {
                // Create new day if it doesn't exist
                dayData = {
                    dayNumber: data.dayNumber,
                    dayTitle: data.dayTitle,
                    date: new Date(data.dateObj),
                    dateStr: data.dateStr,
                    sortKey: data.dateObj.getTime(),
                    activities: []
                };
                tripData.days.push(dayData);
                // Sort days by date
                tripData.days.sort((a, b) => a.sortKey - b.sortKey);
            }

            // Add the new activity
            dayData.activities.push({
                name: data.name,
                category: data.category || 'Others',
                details: data.details || '',
                cost: data.cost || '',
                note: data.note || '',
                link: data.link || '',
                location: data.location || '',
                time: data.time || ''
            });

            // Sort activities by time within the day
            dayData.activities.sort((a, b) => {
                if (!a.time && !b.time) return 0;
                if (!a.time) return 1;
                if (!b.time) return -1;
                return a.time.localeCompare(b.time);
            });

            // Update cache
            localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));
        }

        async function saveToGoogleSheets() {
            const errorDiv = document.getElementById('errorMessage');
            const saveBtn = document.getElementById('saveButton');
            const overlay = document.getElementById('loadingOverlay');

            // Check if Apps Script URL is configured
            if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                errorDiv.innerHTML = '<div class="error-message">‚ö†Ô∏è Please configure your Apps Script URL first!</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
                return;
            }

            // Read ALL form values
            const dateInput = document.getElementById('addDate').value;
            const timeInput = document.getElementById('addTime').value;
            const dayTitleInput = document.getElementById('addDayTitle').value.trim();
            const nameInput = document.getElementById('addName').value.trim();
            const categoryInput = document.getElementById('addCategory').value;
            const detailsInput = document.getElementById('addDetails').value.trim();
            const costInput = document.getElementById('addCost').value.trim();
            const noteInput = document.getElementById('addNote').value.trim();
            const linkInput = document.getElementById('addLink').value.trim();
            const locationInput = document.getElementById('addLocation').value.trim();

            // CRITICAL DEBUG - Check form inputs
            console.log('üîç FORM INPUTS READ:');
            console.log('dateInput:', dateInput, '(type:', typeof dateInput, ')');
            console.log('timeInput:', timeInput);
            console.log('dayTitleInput:', dayTitleInput);
            console.log('nameInput:', nameInput);
            console.log('categoryInput:', categoryInput);
            console.log('locationInput:', locationInput);

            if (!dateInput || !nameInput) {
                errorDiv.innerHTML = '<div class="error-message">‚ö†Ô∏è Please fill in Date and Activity Name</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
                return;
            }

            // Parse the date (format: YYYY-MM-DD from date picker)
            const dateObj = new Date(dateInput + 'T12:00:00');
            const day = dateObj.getDate();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthFull = monthNames[dateObj.getMonth()];

            // CRITICAL: Calculate day number from the date
            const calculatedDayNumber = day.toString();

            // CRITICAL: Determine final day title
            let finalDayTitle = '';
            if (dayTitleInput && dayTitleInput !== '') {
                // User provided a day title
                finalDayTitle = dayTitleInput;
            } else {
                // Auto-generate or use existing
                const existingDay = tripData.days.find(d => d.dayNumber === calculatedDayNumber);
                if (existingDay) {
                    finalDayTitle = existingDay.dayTitle;
                } else {
                    finalDayTitle = `Trip Day - ${monthFull} ${day}`;
                }
            }

            // Create data object with EXACT field names that Apps Script expects
            const data = {
                dateStr: dateInput,                       // A: Date (YYYY-MM-DD)
                dayNumber: calculatedDayNumber,           // B: DayNumber
                dayTitle: finalDayTitle,                  // C: DayTitle
                name: nameInput,                          // D: ActivityName
                details: detailsInput,                    // E: ActivityDetails
                cost: costInput,                          // F: Cost
                note: noteInput,                          // G: Note
                link: linkInput,                          // H: Link
                category: categoryInput || 'Others',      // I: Category
                location: locationInput,                  // J: Location
                time: timeInput,                          // K: Time (HH:MM)
                dateObj: dateObj                          // For local use only
            };

            // DETAILED DEBUG LOGGING
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç DATA TO GOOGLE SHEETS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('Column A (Date):', data.dateStr);
            console.log('Column B (DayNumber):', data.dayNumber);
            console.log('Column C (DayTitle):', data.dayTitle);
            console.log('Column D (ActivityName):', data.name);
            console.log('Column E (ActivityDetails):', data.details);
            console.log('Column F (Cost):', data.cost);
            console.log('Column G (Note):', data.note);
            console.log('Column H (Link):', data.link);
            console.log('Column I (Category):', data.category);
            console.log('Column J (Location):', data.location);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            // Validate required fields
            if (!data.dateStr || !data.dayNumber || !data.name) {
                console.error('‚ùå ERROR: Missing required fields!');
                console.error('dateStr:', data.dateStr);
                console.error('dayNumber:', data.dayNumber);
                console.error('name:', data.name);
                errorDiv.innerHTML = '<div class="error-message">‚ùå Error: Missing required data. Check console.</div>';
                setTimeout(() => errorDiv.innerHTML = '', 3000);
                saveBtn.disabled = false;
                overlay.classList.remove('active');
                return;
            }

            saveBtn.disabled = true;
            overlay.classList.add('active');
            errorDiv.innerHTML = '';

            // Check if we're editing
            if (window.editingActivity) {
                const { dayIndex, activityIndex } = window.editingActivity;

                // Update local data
                tripData.days[dayIndex].activities[activityIndex] = {
                    name: nameInput,
                    category: categoryInput || 'Others',
                    details: detailsInput,
                    cost: costInput,
                    note: noteInput,
                    link: linkInput,
                    location: locationInput,
                    time: timeInput
                };

                // Update cache
                localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));

                // Close modal first
                closeAddModal();

                // Re-render
                render();

                // Show success message
                errorDiv.innerHTML = '<div class="success-message">‚úÖ Updated! (Local only - refresh to sync)</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);

                saveBtn.disabled = false;
                overlay.classList.remove('active');
                return;
            }

            try {
                // Create a completely fresh object to send to Google Sheets
                // Use explicit values, not references
                const payload = {
                    dateStr: String(dateInput),
                    dayNumber: String(calculatedDayNumber),
                    dayTitle: String(finalDayTitle),
                    name: String(nameInput),
                    details: String(detailsInput),
                    cost: String(costInput),
                    note: String(noteInput),
                    link: String(linkInput),
                    category: String(categoryInput || 'Others'),
                    location: String(locationInput),
                    time: String(timeInput)
                };

                // Log everything
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üì§ PAYLOAD TO GOOGLE SHEETS:');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('1. dateStr:', payload.dateStr);
                console.log('2. dayNumber:', payload.dayNumber);
                console.log('3. dayTitle:', payload.dayTitle);
                console.log('4. name:', payload.name);
                console.log('5. details:', payload.details);
                console.log('6. cost:', payload.cost);
                console.log('7. note:', payload.note);
                console.log('8. link:', payload.link);
                console.log('9. category:', payload.category);
                console.log('10. location:', payload.location);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('JSON:', JSON.stringify(payload));
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                // Close modal immediately
                closeAddModal();

                // Show success message with helpful tip
                errorDiv.innerHTML = '<div class="success-message">‚úÖ Saved! Item added to your list.<br><small style="opacity: 0.9; font-size: 12px;">Tap üîÑ in 15-30 sec to sync with Google Sheets</small></div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 4000);

                // Add the item to local data immediately for instant feedback
                // Use the same payload structure
                const localData = {
                    ...payload,
                    dateObj: dateObj
                };
                addItemToLocalData(localData);
                render();

                // Mark that we just added an item
                lastAddedTime = Date.now();

                // DON'T auto-refresh - let the 2-minute interval handle it
                // Google Sheets CSV takes 10-30 seconds to update anyway
                // The 2-minute auto-refresh will catch it later
                // Auto-refresh is also blocked for 60 seconds after adding

            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                closeAddModal();
                errorDiv.innerHTML = '<div class="error-message">‚ùå Failed to save. Check your connection.</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
            } finally {
                saveBtn.disabled = false;
                overlay.classList.remove('active');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            // Start Orlando clock
            updateOrlandoClock();
            setInterval(updateOrlandoClock, 1000); // Update every second

            const cached = localStorage.getItem('orlandoTripCache');
            if (cached) {
                tripData = JSON.parse(cached);
                const cachedUpdate = localStorage.getItem('orlandoTripLastUpdate');
                lastUpdate = cachedUpdate ? new Date(cachedUpdate) : null;
                render();
                updateSyncStatus();
            }

            loadFromSheets();

            // Auto-refresh every 2 minutes to see updates from other phones
            setInterval(() => {
                loadFromSheets();
            }, 2 * 60 * 1000);

            // Update sync status every minute
            setInterval(updateSyncStatus, 60000);

            // Update Next Activity every minute (in case time has passed)
            setInterval(updateNextActivity, 60000);
        });
    </script>
</body>
</html>

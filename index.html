<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Orlando Trip">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6366f1">
    <title>üè∞ Orlando Trip</title>
    <link rel="icon" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 20px 10px;
            padding-bottom: 90px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #1e1e2e;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid rgba(138, 106, 255, 0.2);
            margin-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .orlando-clock {
            font-size: 18px;
            font-weight: 600;
            margin-top: 8px;
            opacity: 0.95;
            letter-spacing: 1px;
        }

        .weekday-label {
            font-size: 10px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .next-activity-card {
            background: rgba(255,255,255,0.15);
            padding: 16px;
            border-radius: 14px;
            margin-top: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .next-activity-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .next-activity-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .next-activity-time {
            font-size: 14px;
            opacity: 0.9;
        }

        .budget-summary {
            background: rgba(30, 30, 46, 0.8);
            padding: 24px 20px;
            border-top: 1px solid rgba(138, 106, 255, 0.2);
        }

        .budget-title {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .budget-amount {
            font-size: 32px;
            font-weight: 700;
            color: #e5e7eb;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chart-container {
            margin-top: 20px;
        }

        .chart-title {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .chart-wrapper {
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pie-chart-canvas {
            width: 200px;
            height: 200px;
        }

        .legend {
            flex: 1;
            min-width: 200px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-label {
            color: #e5e7eb;
            flex: 1;
        }

        .legend-amount {
            color: #9ca3af;
            font-weight: 600;
        }

        .sync-status {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(138, 106, 255, 0.2);
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 10px 20px;
            transition: all 0.3s;
            font-size: 26px;
            border-radius: 12px;
            min-width: 80px;
            flex: 1;
        }

        .nav-btn-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #a78bfa;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.active {
            color: #a855f7;
            background: rgba(99, 102, 241, 0.15);
        }

        .nav-btn.add-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            min-width: 64px;
            max-width: 64px;
            padding: 0;
            margin-top: -28px;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5);
            font-size: 32px;
            border: 4px solid rgba(30, 30, 46, 1);
            flex: none;
            gap: 0;
        }

        .nav-btn.add-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.6);
            transform: translateY(-4px);
        }

        .nav-btn.add-btn:active {
            transform: translateY(-2px) scale(0.95);
        }

        .nav-btn.add-btn .nav-btn-label {
            display: none;
        }

        .nav-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .nav-btn.disabled:hover {
            background: none;
            color: #9ca3af;
            transform: none;
        }

        .nav-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .day-section {
            border-bottom: 1px solid rgba(138, 106, 255, 0.1);
        }

        .day-header {
            background: rgba(99, 102, 241, 0.1);
            padding: 15px 20px;
            font-weight: bold;
            color: #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 10;
        }

        .day-header:hover {
            background: rgba(99, 102, 241, 0.15);
        }

        .day-header:active {
            background: rgba(99, 102, 241, 0.2);
        }

        .day-number {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            min-width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            padding: 0 12px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .activities {
            padding: 0;
        }

        .activity {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(138, 106, 255, 0.08);
            position: relative;
            background: rgba(30, 30, 46, 0.5);
            transition: background 0.2s;
        }

        .activity:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .activity:last-child {
            border-bottom: none;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .activity-name {
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 5px;
            font-size: 15px;
            flex: 1;
        }

        .activity-menu {
            position: relative;
            z-index: 100;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            line-height: 1;
        }

        .menu-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            color: #a855f7;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: #2d2d44;
            border: 1px solid rgba(138, 106, 255, 0.3);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            min-width: 120px;
            margin-top: 4px;
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: #e5e7eb;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .menu-item:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .menu-item.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .activity-details {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.6;
        }

        .cost {
            display: inline-block;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
            color: #a78bfa;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            margin-top: 8px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .note {
            background: rgba(245, 158, 11, 0.1);
            padding: 10px 14px;
            border-radius: 10px;
            margin-top: 8px;
            font-size: 12px;
            color: #fbbf24;
            border-left: 3px solid #f59e0b;
        }

        .link {
            color: #818cf8;
            word-break: break-all;
            text-decoration: none;
            display: block;
            margin-top: 8px;
            font-size: 13px;
        }

        .link:hover {
            color: #a78bfa;
        }

        .directions-buttons {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .directions-btn {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            color: #9ca3af;
            padding: 4px 8px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid rgba(156, 163, 175, 0.2);
            background: rgba(30, 30, 46, 0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .directions-btn.google:hover {
            background: rgba(66, 133, 244, 0.1);
            color: #60a5fa;
            border-color: rgba(66, 133, 244, 0.3);
        }

        .directions-btn.waze:hover {
            background: rgba(51, 204, 255, 0.1);
            color: #38bdf8;
            border-color: rgba(51, 204, 255, 0.3);
        }

        .directions-btn:active {
            transform: scale(0.98);
        }

        .footer {
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            background: rgba(30, 30, 46, 0.5);
        }

        .collapsed .activities {
            display: none;
        }

        .arrow {
            transition: transform 0.3s;
        }

        .collapsed .arrow {
            transform: rotate(-90deg);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e1e2e;
            border-radius: 20px;
            padding: 28px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(138, 106, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
        }

        .modal-header {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 24px;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #9ca3af;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(138, 106, 255, 0.2);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: rgba(30, 30, 46, 0.8);
            color: #e5e7eb;
            transition: all 0.2s;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(30, 30, 46, 1);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Calendar and time picker icons */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.7) sepia(1) saturate(5) hue-rotate(220deg);
            cursor: pointer;
        }

        /* Dark theme for date picker */
        input[type="date"]::-webkit-datetime-edit-fields-wrapper {
            color: #e5e7eb;
        }

        input[type="date"]::-webkit-datetime-edit-text {
            color: #9ca3af;
        }

        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field {
            color: #e5e7eb;
        }

        /* Dark theme for time picker */
        input[type="time"]::-webkit-datetime-edit-fields-wrapper {
            color: #e5e7eb;
        }

        input[type="time"]::-webkit-datetime-edit-text {
            color: #9ca3af;
        }

        input[type="time"]::-webkit-datetime-edit-hour-field,
        input[type="time"]::-webkit-datetime-edit-minute-field,
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            color: #e5e7eb;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-buttons .cancel {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .modal-buttons .cancel:hover {
            background: rgba(107, 114, 128, 0.3);
            color: #e5e7eb;
        }

        .modal-buttons .save {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .modal-buttons .save:hover {
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .modal-buttons .save:disabled {
            background: rgba(107, 114, 128, 0.3);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .error-message {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 14px;
            border-radius: 0;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            animation: slideDown 0.3s ease;
        }

        .success-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 14px;
            border-radius: 0;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
        }

        .loading-spinner {
            font-size: 40px;
            animation: spin 1s linear infinite;
        }

        /* Checklist Specific Styles */
        .checklist-item {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(138, 106, 255, 0.08);
            background: rgba(30, 30, 46, 0.5);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: grab;
            user-select: none;
            position: relative;
        }

        .checklist-item:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .checklist-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            background: rgba(139, 92, 246, 0.2);
            border: 2px dashed rgba(139, 92, 246, 0.5);
        }

        .checklist-item.drag-over {
            border-top: 3px solid #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .drag-handle {
            color: #6b7280;
            font-size: 18px;
            cursor: grab;
            padding: 4px;
            margin-left: -8px;
            transition: color 0.2s;
        }

        .drag-handle:hover {
            color: #a78bfa;
        }

        .checklist-item.dragging .drag-handle {
            cursor: grabbing;
            color: #8b5cf6;
        }

        .checklist-item:active {
            cursor: grabbing;
        }

        .checklist-checkbox {
            width: 22px;
            height: 22px;
            min-width: 22px;
            border: 2px solid rgba(138, 106, 255, 0.4);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            background: rgba(30, 30, 46, 0.8);
        }

        .checklist-checkbox.checked {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
        }

        .checklist-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .checklist-item-text {
            flex: 1;
            color: #e5e7eb;
            font-size: 14px;
        }

        .checklist-item.checked .checklist-item-text {
            color: #6b7280;
            text-decoration: line-through;
        }

        .list-progress {
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
            margin-left: 12px;
        }

        .category-header {
            background: rgba(99, 102, 241, 0.08);
            padding: 10px 20px;
            font-weight: 600;
            color: #9ca3af;
            font-size: 13px;
            border-bottom: 1px solid rgba(138, 106, 255, 0.1);
        }

        .delete-list-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }

        .delete-list-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Pull to Refresh */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-60px);
            background: rgba(99, 102, 241, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3000;
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .pull-to-refresh.visible {
            transform: translateX(-50%) translateY(20px);
        }

        .pull-to-refresh.refreshing {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
    </style>
</head>
<body>
    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pullToRefreshIndicator">üîÑ Pull to refresh</div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">‚è≥</div>
            <p style="margin-top: 15px; color: #666;">Saving to Google Sheets...</p>
        </div>
    </div>

    <div class="container" id="container">
        <div class="header">
            <h1>üè∞ Orlando Trip</h1>
            <p>Panama ‚úàÔ∏è Orlando Adventure</p>
            <div class="orlando-clock" id="orlandoClock">üïê Loading...</div>
            <div class="next-activity-card" id="nextActivityCard">
                <div class="next-activity-label">üéØ Next Activity</div>
                <div class="next-activity-name" id="nextActivityName">Loading...</div>
                <div class="next-activity-time" id="nextActivityTime"></div>
            </div>
            <div class="sync-status" id="syncStatus">
                Last synced: Never
            </div>
        </div>

        <div id="errorMessage"></div>
        <div id="tripContent"></div>

        <div class="budget-summary">
            <div class="budget-title">Total Budget</div>
            <div class="budget-amount" id="totalBudget">$0.00</div>

            <div class="chart-container">
                <div class="chart-title">Spending by Category</div>
                <div class="chart-wrapper">
                    <canvas id="pieChart" class="pie-chart-canvas" width="200" height="200"></canvas>
                    <div class="legend" id="chartLegend"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checklist Container (hidden by default) -->
    <div class="container" id="checklistContainer" style="display: none;">
        <div class="header">
            <h1>‚úì Checklists</h1>
            <p>Pack & Prepare for Orlando</p>
            <div class="sync-status" id="checklistSyncStatus">
                Last synced: Never
            </div>
        </div>

        <div id="checklistError"></div>
        <div id="checklistContent"></div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-btn active" id="activitiesTab" onclick="switchToActivities()">
            <span>üìÖ</span>
            <span class="nav-btn-label">Activities</span>
        </button>
        <button class="nav-btn add-btn" id="addButton" onclick="openAddModalSmart()">
            <span>‚ûï</span>
        </button>
        <button class="nav-btn" id="checklistTab" onclick="switchToChecklist()">
            <span>‚úì</span>
            <span class="nav-btn-label">Checklist</span>
        </button>
    </div>

    <!-- Add Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">‚ûï Add Expense</div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="addDate" value="2025-10-30" min="2025-10-30" max="2025-11-09" onchange="autoFillDayTitle()">
            </div>
            <div class="form-group">
                <label>Time (Orlando GMT-4)</label>
                <input type="time" id="addTime" placeholder="14:00">
                <small style="color: #9ca3af; font-size: 11px; margin-top: 4px; display: block;">
                    üí° Optional - for scheduling and Next Activity
                </small>
            </div>
            <div class="form-group">
                <label>Day Title</label>
                <input type="text" id="addDayTitle" placeholder="e.g., Arrival Day - October 30">
                <small style="color: #9ca3af; font-size: 11px; margin-top: 4px; display: block;">
                    üí° Auto-fills from existing day or leave empty to auto-generate
                </small>
            </div>
            <div class="form-group">
                <label>Activity Name</label>
                <input type="text" id="addName" placeholder="üçï Lunch at...">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="addCategory" onchange="addCategoryEmoji()">
                    <option value="">Select category...</option>
                    <option value="Parks">üé¢ Parks</option>
                    <option value="Food">üçΩÔ∏è Food</option>
                    <option value="Hotels">üè® Hotels</option>
                    <option value="Car">üöó Car</option>
                    <option value="Flights">‚úàÔ∏è Flights</option>
                    <option value="Shopping">üõçÔ∏è Shopping</option>
                    <option value="Others">‚≠ê Others</option>
                </select>
            </div>
            <div class="form-group">
                <label>Details (optional)</label>
                <textarea id="addDetails" placeholder="Location, time, etc."></textarea>
            </div>
            <div class="form-group">
                <label>Cost</label>
                <input type="text" id="addCost" placeholder="25.50" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*">
            </div>
            <div class="form-group">
                <label>Link (optional)</label>
                <input type="text" id="addLink" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Location/Address (optional)</label>
                <input type="text" id="addLocation" placeholder="123 Main St, Orlando, FL">
                <small style="color: #9ca3af; font-size: 11px; margin-top: 4px; display: block;">
                    üí° Add address for directions button
                </small>
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeAddModal()">Cancel</button>
                <button class="save" id="saveButton" onclick="saveToGoogleSheets()">Add & Sync</button>
            </div>
        </div>
    </div>

    <!-- Add Checklist Item Modal -->
    <div class="modal" id="checklistItemModal">
        <div class="modal-content">
            <div class="modal-header" id="checklistModalHeader">‚ûï Add Checklist Item</div>
            <div class="form-group">
                <label>List</label>
                <select id="checklistListSelect" onchange="handleListSelection()">
                    <option value="">Select list...</option>
                    <option value="__new__">‚ûï Create New List</option>
                </select>
            </div>
            <div class="form-group" id="newListGroup" style="display: none;">
                <label>New List Name</label>
                <input type="text" id="newListName" placeholder="e.g., Mala do Luciano">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="checklistCategorySelect">
                    <option value="">Select category...</option>
                    <option value="üëï Roupa">üëï Roupa</option>
                    <option value="üß¥ Higiene">üß¥ Higiene</option>
                    <option value="üíä Rem√©dios">üíä Rem√©dios</option>
                    <option value="üìÑ Documentos">üìÑ Documentos</option>
                    <option value="‚ö° Eletr√¥nicos">‚ö° Eletr√¥nicos</option>
                    <option value="üß¢ Outros">üß¢ Outros</option>
                </select>
            </div>
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="checklistItemName" placeholder="e.g., 5 camisetas">
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeChecklistModal()">Cancel</button>
                <button class="save" id="saveChecklistButton" onclick="saveChecklistItem()">Add Item</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        // Replace these URLs with your own:
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRqRXPlZ9rUIdzmFViPERuMfTUo0AlCd_vy9Hj-A-RoqmhGcy0--55OJnYBnxXLMV74x0n9iDg5zqvG/pub?gid=1054467242&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxFvOfZUE6WEFHnYcdbw2nvgiQ1Pw0c6r2QvFzrKcgtBkJ7wTQ-lUb1r3hEsB91K0WM/exec';
        const CHECKLIST_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRqRXPlZ9rUIdzmFViPERuMfTUo0AlCd_vy9Hj-A-RoqmhGcy0--55OJnYBnxXLMV74x0n9iDg5zqvG/pub?gid=388682998&single=true&output=csv';

        let tripData = { days: [] };
        let checklistData = { lists: [] };
        let currentView = 'activities';  // 'activities' or 'checklist'
        let lastUpdate = null;
        let lastAddedTime = null;

        // PULL TO REFRESH
        let pullStartY = 0;
        let isPulling = false;
        const pullThreshold = 80;

        function initPullToRefresh() {
            let pullDistance = 0;
            const indicator = document.getElementById('pullToRefreshIndicator');

            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (!isPulling || window.scrollY > 0) return;

                const touchY = e.touches[0].clientY;
                pullDistance = touchY - pullStartY;

                if (pullDistance > 0 && pullDistance < pullThreshold * 2) {
                    indicator.classList.add('visible');
                    indicator.textContent = pullDistance > pullThreshold ? 'üîÑ Release to refresh' : 'üîÑ Pull to refresh';
                }
            });

            document.addEventListener('touchend', async (e) => {
                if (!isPulling) return;

                if (pullDistance > pullThreshold) {
                    indicator.textContent = '‚è≥ Refreshing...';
                    indicator.classList.add('refreshing');

                    await refreshCurrentView();

                    setTimeout(() => {
                        indicator.classList.remove('visible', 'refreshing');
                    }, 500);
                } else {
                    indicator.classList.remove('visible');
                }

                isPulling = false;
                pullDistance = 0;
            });
        }

        // VIEW SWITCHING FUNCTIONS
        function switchToActivities() {
            currentView = 'activities';
            document.getElementById('container').style.display = 'block';
            document.getElementById('checklistContainer').style.display = 'none';
            document.getElementById('activitiesTab').classList.add('active');
            document.getElementById('checklistTab').classList.remove('active');
        }

        function switchToChecklist() {
            currentView = 'checklist';
            document.getElementById('container').style.display = 'none';
            document.getElementById('checklistContainer').style.display = 'block';
            document.getElementById('activitiesTab').classList.remove('active');
            document.getElementById('checklistTab').classList.add('active');

            // Load checklist data if not loaded
            if (checklistData.lists.length === 0) {
                loadChecklistData();
            }
        }

        async function refreshCurrentView() {
            if (currentView === 'activities') {
                await loadFromSheets(true);
            } else {
                await loadChecklistData(true);
            }
        }

        // CHECKLIST DATA FUNCTIONS
        function parseChecklistCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const data = { lists: {} };

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const fields = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                fields.push(current.trim());

                const [listName, category, itemName, isDone] = fields;

                if (!listName || !itemName) continue;

                if (!data.lists[listName]) {
                    data.lists[listName] = {
                        name: listName,
                        categories: {}
                    };
                }

                if (!data.lists[listName].categories[category]) {
                    data.lists[listName].categories[category] = [];
                }

                data.lists[listName].categories[category].push({
                    name: itemName,
                    isDone: String(isDone).toLowerCase() === 'true'
                });
            }

            return { lists: Object.values(data.lists) };
        }

        async function loadChecklistData(forceRefresh = false) {
            const errorDiv = document.getElementById('checklistError');
            const statusDiv = document.getElementById('checklistSyncStatus');

            errorDiv.innerHTML = '';

            try {
                const response = await fetch(CHECKLIST_CSV_URL + '&t=' + Date.now());
                const csv = await response.text();

                checklistData = parseChecklistCSV(csv);

                // Load from localStorage for isDone states
                const cached = localStorage.getItem('checklistCache');
                if (cached) {
                    const cachedData = JSON.parse(cached);
                    // Merge isDone states from cache
                    checklistData.lists.forEach(list => {
                        const cachedList = cachedData.lists.find(l => l.name === list.name);
                        if (cachedList) {
                            Object.keys(list.categories).forEach(category => {
                                const cachedCategory = cachedList.categories[category];
                                if (cachedCategory) {
                                    list.categories[category].forEach((item, idx) => {
                                        if (cachedCategory[idx]) {
                                            item.isDone = cachedCategory[idx].isDone;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }

                renderChecklists();
                statusDiv.textContent = `Last synced: ${new Date().toLocaleTimeString()}`;

                console.log('‚úÖ Checklists loaded!');
                console.log('üí° TIP: Hold and drag the ‚ò∞ handle to reorder items within a category');

            } catch (error) {
                console.error('Error loading checklist:', error);
                errorDiv.innerHTML = '<div class="error-message">‚ùå Failed to load checklists. Check CSV URL.</div>';
            }
        }

        function renderChecklists() {
            const content = document.getElementById('checklistContent');
            content.innerHTML = '';

            checklistData.lists.forEach((list, listIndex) => {
                const totalItems = Object.values(list.categories).flat().length;
                const doneItems = Object.values(list.categories).flat().filter(item => item.isDone).length;
                const progress = totalItems > 0 ? Math.round((doneItems / totalItems) * 100) : 0;

                const listSection = document.createElement('div');
                listSection.className = 'day-section';
                listSection.dataset.list = listIndex;

                let categoriesHTML = '';
                Object.keys(list.categories).forEach(category => {
                    categoriesHTML += `<div class="category-header">${category}</div>`;

                    list.categories[category].forEach((item, itemIndex) => {
                        const itemId = `${listIndex}-${category}-${itemIndex}`;
                        const escapedCategory = category.replace(/'/g, "\\'");
                        categoriesHTML += `
                            <div class="checklist-item ${item.isDone ? 'checked' : ''}"
                                 data-item-id="${itemId}"
                                 data-list-index="${listIndex}"
                                 data-category="${category}"
                                 data-item-index="${itemIndex}"
                                 draggable="true"
                                 ondragstart="handleDragStart(event)"
                                 ondragend="handleDragEnd(event)"
                                 ondragover="handleDragOver(event)"
                                 ondrop="handleDrop(event)"
                                 ondragleave="handleDragLeave(event)"
                                 ontouchstart="handleTouchStart(event)"
                                 ontouchmove="handleTouchMove(event)"
                                 ontouchend="handleTouchEnd(event)">
                                <div class="drag-handle">‚ò∞</div>
                                <div class="checklist-checkbox ${item.isDone ? 'checked' : ''}"
                                     onclick="toggleChecklistItem(${listIndex}, '${escapedCategory}', ${itemIndex})"></div>
                                <div class="checklist-item-text">${item.name}</div>
                                <div class="activity-menu">
                                    <button class="menu-btn" onclick="toggleMenu('menu-${itemId}', event)">‚ãÆ</button>
                                    <div class="menu-dropdown" id="menu-${itemId}">
                                        <div class="menu-item" onclick="editChecklistItem(${listIndex}, '${escapedCategory}', ${itemIndex}, event)">
                                            ‚úèÔ∏è Edit
                                        </div>
                                        <div class="menu-item delete" onclick="deleteChecklistItem(${listIndex}, '${escapedCategory}', ${itemIndex})">
                                            üóëÔ∏è Delete
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });

                const listMenuId = `list-menu-${listIndex}`;

                listSection.innerHTML = `
                    <div class="day-header" onclick="toggleList(${listIndex})">
                        <div style="display: flex; align-items: center; flex: 1; gap: 12px;">
                            <div class="day-number" style="min-width: 60px;">${progress}%</div>
                            <span style="flex: 1;">${list.name}</span>
                            <div class="activity-menu" style="position: relative;">
                                <button class="menu-btn" onclick="toggleMenu('${listMenuId}', event)">‚ãÆ</button>
                                <div class="menu-dropdown" id="${listMenuId}">
                                    <div class="menu-item" onclick="editListName(${listIndex}, event)">
                                        ‚úèÔ∏è Edit List Name
                                    </div>
                                    <div class="menu-item delete" onclick="deleteList(${listIndex}, event)">
                                        üóëÔ∏è Delete List
                                    </div>
                                </div>
                            </div>
                            <span class="arrow">‚ñº</span>
                        </div>
                    </div>
                    <div class="activities">
                        ${categoriesHTML}
                    </div>
                `;

                content.appendChild(listSection);
            });
        }

        function toggleList(listIndex) {
            const listSection = document.querySelector(`.day-section[data-list="${listIndex}"]`);
            listSection.classList.toggle('collapsed');
        }

        // DRAG AND DROP FUNCTIONS
        let draggedElement = null;
        let draggedData = null;
        let touchStartY = 0;
        let isDragging = false;

        function handleDragStart(event) {
            draggedElement = event.target;
            draggedData = {
                listIndex: parseInt(draggedElement.dataset.listIndex),
                category: draggedElement.dataset.category,
                itemIndex: parseInt(draggedElement.dataset.itemIndex)
            };

            draggedElement.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(event) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }

            // Remove drag-over class from all items
            document.querySelectorAll('.checklist-item.drag-over').forEach(item => {
                item.classList.remove('drag-over');
            });

            draggedElement = null;
            draggedData = null;
        }

        function handleDragOver(event) {
            event.preventDefault();

            const targetElement = event.target.closest('.checklist-item');
            if (!targetElement || targetElement === draggedElement) return;

            // Check if same category
            const targetCategory = targetElement.dataset.category;
            if (draggedData && targetCategory === draggedData.category) {
                targetElement.classList.add('drag-over');
                event.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDragLeave(event) {
            const targetElement = event.target.closest('.checklist-item');
            if (targetElement) {
                targetElement.classList.remove('drag-over');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();

            const targetElement = event.target.closest('.checklist-item');
            if (!targetElement || !draggedData || targetElement === draggedElement) return;

            const targetListIndex = parseInt(targetElement.dataset.listIndex);
            const targetCategory = targetElement.dataset.category;
            const targetItemIndex = parseInt(targetElement.dataset.itemIndex);

            // Only allow reordering within same category
            if (draggedData.listIndex !== targetListIndex || draggedData.category !== targetCategory) {
                return;
            }

            // Reorder items
            const list = checklistData.lists[draggedData.listIndex];
            const items = list.categories[draggedData.category];
            const [movedItem] = items.splice(draggedData.itemIndex, 1);

            // Calculate new index based on whether we're moving up or down
            let newIndex = targetItemIndex;
            if (draggedData.itemIndex < targetItemIndex) {
                newIndex = targetItemIndex;
            }

            items.splice(newIndex, 0, movedItem);

            // Save and re-render
            localStorage.setItem('checklistCache', JSON.stringify(checklistData));
            renderChecklists();

            console.log('‚úÖ Item reordered:', movedItem.name);
        }

        // TOUCH SUPPORT FOR MOBILE
        let touchDragElement = null;
        let touchClone = null;

        function handleTouchStart(event) {
            // Only activate drag on the drag handle itself
            const dragHandle = event.target.closest('.drag-handle');
            if (!dragHandle) {
                touchDragElement = null;
                return;
            }

            const touch = event.touches[0];
            touchStartY = touch.clientY;

            const element = event.target.closest('.checklist-item');
            if (!element) return;

            touchDragElement = element;

            // Start drag immediately when touching the handle
            setTimeout(() => {
                if (touchDragElement === element) {
                    isDragging = true;
                    element.classList.add('dragging');

                    // Haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }

                    // Create visual clone for feedback
                    touchClone = element.cloneNode(true);
                    touchClone.style.position = 'fixed';
                    touchClone.style.width = element.offsetWidth + 'px';
                    touchClone.style.opacity = '0.8';
                    touchClone.style.zIndex = '3000';
                    touchClone.style.pointerEvents = 'none';
                    document.body.appendChild(touchClone);
                }
            }, 200);  // Reduced to 200ms for faster response
        }

        function handleTouchMove(event) {
            if (!isDragging || !touchClone) return;

            event.preventDefault();
            const touch = event.touches[0];

            // Move clone with finger
            touchClone.style.left = '50%';
            touchClone.style.transform = 'translateX(-50%)';
            touchClone.style.top = (touch.clientY - 30) + 'px';

            // Find element under touch
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetElement = elementBelow?.closest('.checklist-item');

            // Remove all drag-over classes
            document.querySelectorAll('.checklist-item.drag-over').forEach(item => {
                item.classList.remove('drag-over');
            });

            // Add drag-over to target if valid
            if (targetElement && targetElement !== touchDragElement) {
                const targetCategory = targetElement.dataset.category;
                const dragCategory = touchDragElement.dataset.category;
                if (targetCategory === dragCategory) {
                    targetElement.classList.add('drag-over');
                }
            }
        }

        function handleTouchEnd(event) {
            if (!isDragging) {
                touchDragElement = null;
                return;
            }

            const touch = event.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetElement = elementBelow?.closest('.checklist-item');

            if (targetElement && targetElement !== touchDragElement) {
                const dragListIndex = parseInt(touchDragElement.dataset.listIndex);
                const dragCategory = touchDragElement.dataset.category;
                const dragItemIndex = parseInt(touchDragElement.dataset.itemIndex);

                const targetListIndex = parseInt(targetElement.dataset.listIndex);
                const targetCategory = targetElement.dataset.category;
                const targetItemIndex = parseInt(targetElement.dataset.itemIndex);

                // Only reorder within same category
                if (dragListIndex === targetListIndex && dragCategory === targetCategory) {
                    const list = checklistData.lists[dragListIndex];
                    const items = list.categories[dragCategory];
                    const [movedItem] = items.splice(dragItemIndex, 1);

                    let newIndex = targetItemIndex;
                    if (dragItemIndex < targetItemIndex) {
                        newIndex = targetItemIndex;
                    }

                    items.splice(newIndex, 0, movedItem);

                    localStorage.setItem('checklistCache', JSON.stringify(checklistData));
                    renderChecklists();

                    console.log('‚úÖ Item reordered (touch):', movedItem.name);
                }
            }

            // Cleanup
            if (touchClone) {
                touchClone.remove();
                touchClone = null;
            }

            if (touchDragElement) {
                touchDragElement.classList.remove('dragging');
            }

            document.querySelectorAll('.checklist-item.drag-over').forEach(item => {
                item.classList.remove('drag-over');
            });

            isDragging = false;
            touchDragElement = null;
        }

        function editListName(listIndex, event) {
            event.stopPropagation();

            const list = checklistData.lists[listIndex];
            const newName = prompt('Enter new list name:', list.name);

            if (!newName || newName.trim() === '' || newName === list.name) return;

            const oldName = list.name;
            list.name = newName.trim();

            // Save to localStorage
            localStorage.setItem('checklistCache', JSON.stringify(checklistData));

            renderChecklists();

            // Show success message
            const errorDiv = document.getElementById('checklistError');
            errorDiv.innerHTML = `<div class="success-message">‚úÖ List renamed!</div>`;
            setTimeout(() => errorDiv.innerHTML = '', 2000);

            console.log(`‚úèÔ∏è List renamed from "${oldName}" to "${newName}"`);
            console.log('Note: This change is local only. To sync to Sheets, manually update the ListName column.');
        }

        function editChecklistItem(listIndex, category, itemIndex, event) {
            event.stopPropagation();

            // Close the menu
            const itemId = `${listIndex}-${category}-${itemIndex}`;
            const menu = document.getElementById(`menu-${itemId}`);
            if (menu) menu.classList.remove('active');

            const list = checklistData.lists[listIndex];
            const item = list.categories[category][itemIndex];

            const newName = prompt('Edit item:', item.name);

            if (!newName || newName.trim() === '' || newName === item.name) return;

            const oldName = item.name;
            item.name = newName.trim();

            // Save to localStorage
            localStorage.setItem('checklistCache', JSON.stringify(checklistData));

            // Update UI immediately
            renderChecklists();

            // Sync to Google Sheets in background
            syncChecklistItemEdit(list.name, category, oldName, newName.trim());

            // Show success message
            const errorDiv = document.getElementById('checklistError');
            errorDiv.innerHTML = `<div class="success-message">‚úÖ Item updated!</div>`;
            setTimeout(() => errorDiv.innerHTML = '', 2000);
        }

        async function syncChecklistItemEdit(listName, category, oldItemName, newItemName) {
            try {
                const payload = {
                    type: 'checklist',
                    action: 'editItem',
                    listName: listName,
                    category: category,
                    oldItemName: oldItemName,
                    newItemName: newItemName
                };

                console.log('üì§ Syncing item edit to Sheets:', payload);

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('‚úÖ Item name synced to Google Sheets');
            } catch (error) {
                console.error('‚ùå Failed to sync item edit:', error);
            }
        }

        function toggleChecklistItem(listIndex, category, itemIndex) {
            const list = checklistData.lists[listIndex];
            const item = list.categories[category][itemIndex];

            item.isDone = !item.isDone;

            // Save to localStorage immediately
            localStorage.setItem('checklistCache', JSON.stringify(checklistData));

            // Update UI immediately (fast!)
            renderChecklists();

            // Sync to Google Sheets in background (async, non-blocking)
            syncChecklistItemToSheets(list.name, category, item.name, item.isDone);
        }

        async function syncChecklistItemToSheets(listName, category, itemName, isDone) {
            try {
                const payload = {
                    type: 'checklist',
                    action: 'update',
                    listName: listName,
                    category: category,
                    itemName: itemName,
                    isDone: String(isDone)  // Convert boolean to string "true" or "false"
                };

                console.log('üì§ Syncing checklist to Sheets:', payload);

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('‚úÖ Checklist item synced to Google Sheets');
            } catch (error) {
                console.error('‚ùå Failed to sync checklist item:', error);
            }
        }

        async function deleteChecklistItem(listIndex, category, itemIndex) {
            if (!confirm('Delete this item?')) return;

            const list = checklistData.lists[listIndex];
            const item = list.categories[category][itemIndex];

            // Sync deletion to Google Sheets first
            try {
                const payload = {
                    type: 'checklist',
                    action: 'delete',
                    listName: list.name,
                    category: category,
                    itemName: item.name
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('‚úÖ Checklist item deleted from Google Sheets');
            } catch (error) {
                console.error('Failed to delete checklist item:', error);
            }

            // Remove from local data
            checklistData.lists[listIndex].categories[category].splice(itemIndex, 1);

            // Remove category if empty
            if (checklistData.lists[listIndex].categories[category].length === 0) {
                delete checklistData.lists[listIndex].categories[category];
            }

            localStorage.setItem('checklistCache', JSON.stringify(checklistData));
            renderChecklists();
        }

        async function deleteList(listIndex, event) {
            event.stopPropagation();

            const listName = checklistData.lists[listIndex].name;
            if (!confirm(`Delete entire list "${listName}"? This cannot be undone.`)) return;

            // Sync deletion to Google Sheets first
            try {
                const payload = {
                    type: 'checklist',
                    action: 'deleteList',
                    listName: listName
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('‚úÖ Checklist list deleted from Google Sheets');
            } catch (error) {
                console.error('Failed to delete checklist list:', error);
            }

            checklistData.lists.splice(listIndex, 1);
            localStorage.setItem('checklistCache', JSON.stringify(checklistData));
            renderChecklists();
        }

        // CHECKLIST MODAL FUNCTIONS
        function openChecklistModal() {
            // Populate list dropdown
            const listSelect = document.getElementById('checklistListSelect');
            listSelect.innerHTML = '<option value="">Select list...</option><option value="__new__">‚ûï Create New List</option>';

            checklistData.lists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.name;
                option.textContent = list.name;
                listSelect.appendChild(option);
            });

            // Reset form
            listSelect.value = '';
            document.getElementById('newListGroup').style.display = 'none';
            document.getElementById('newListName').value = '';
            document.getElementById('checklistCategorySelect').value = '';
            document.getElementById('checklistItemName').value = '';
            document.getElementById('checklistModalHeader').textContent = '‚ûï Add Checklist Item';

            document.getElementById('checklistItemModal').classList.add('active');
        }

        function closeChecklistModal() {
            document.getElementById('checklistItemModal').classList.remove('active');
        }

        function handleListSelection() {
            const listSelect = document.getElementById('checklistListSelect');
            const newListGroup = document.getElementById('newListGroup');

            if (listSelect.value === '__new__') {
                newListGroup.style.display = 'block';
            } else {
                newListGroup.style.display = 'none';
            }
        }

        async function saveChecklistItem() {
            const listSelect = document.getElementById('checklistListSelect').value;
            const newListName = document.getElementById('newListName').value.trim();
            const category = document.getElementById('checklistCategorySelect').value;
            const itemName = document.getElementById('checklistItemName').value.trim();

            if (!itemName || !category) {
                alert('Please fill in all required fields');
                return;
            }

            let listName = listSelect;
            if (listSelect === '__new__') {
                if (!newListName) {
                    alert('Please enter a name for the new list');
                    return;
                }
                listName = newListName;

                // Create new list
                checklistData.lists.push({
                    name: listName,
                    categories: {}
                });
            }

            // Find the list
            const list = checklistData.lists.find(l => l.name === listName);
            if (!list) {
                alert('List not found');
                return;
            }

            // Add item to category
            if (!list.categories[category]) {
                list.categories[category] = [];
            }

            list.categories[category].push({
                name: itemName,
                isDone: false
            });

            // Save to localStorage
            localStorage.setItem('checklistCache', JSON.stringify(checklistData));

            // Sync to Google Sheets
            try {
                const payload = {
                    type: 'checklist',
                    action: 'add',
                    listName: listName,
                    category: category,
                    itemName: itemName,
                    isDone: 'false'
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('‚úÖ Checklist item synced to Google Sheets');
            } catch (error) {
                console.error('Failed to sync checklist item:', error);
            }

            renderChecklists();
            closeChecklistModal();

            // Show success message
            const errorDiv = document.getElementById('checklistError');
            errorDiv.innerHTML = '<div class="success-message">‚úÖ Item added & synced!</div>';
            setTimeout(() => errorDiv.innerHTML = '', 2000);
        }

        function openGoogleMaps(location) {
            const encodedLocation = encodeURIComponent(location);
            const url = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
            window.open(url, '_blank');
        }

        function openWaze(location) {
            const encodedLocation = encodeURIComponent(location);
            const url = `https://waze.com/ul?q=${encodedLocation}&navigate=yes`;
            window.open(url, '_blank');
        }

        function updateOrlandoClock() {
            const orlandoTime = new Date().toLocaleString('en-US', {
                timeZone: 'America/New_York', // Orlando is GMT-4 (EDT) or GMT-5 (EST)
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });

            const clockEl = document.getElementById('orlandoClock');
            if (clockEl) {
                clockEl.textContent = 'üïê Orlando: ' + orlandoTime;
            }
        }

        function autoFillDayTitle() {
            const dateInput = document.getElementById('addDate').value;
            const dayTitleField = document.getElementById('addDayTitle');

            if (!dateInput) return;

            // Find existing day with this date
            const existingDay = tripData.days.find(d => d.dateStr === dateInput);

            if (existingDay && existingDay.dayTitle) {
                // Auto-fill with existing day title
                dayTitleField.value = existingDay.dayTitle;
                console.log('üìÖ Auto-filled day title:', existingDay.dayTitle);
            } else {
                // Clear if no existing title (let it auto-generate)
                dayTitleField.value = '';
            }
        }

        function addCategoryEmoji() {
            const categoryInput = document.getElementById('addCategory').value;
            const nameField = document.getElementById('addName');
            const currentName = nameField.value.trim();

            if (!categoryInput || !currentName) return;

            // Category emoji mapping
            const categoryEmojis = {
                'Parks': 'üé¢',
                'Food': 'üçΩÔ∏è',
                'Hotels': 'üè®',
                'Car': 'üöó',
                'Flights': '‚úàÔ∏è',
                'Shopping': 'üõçÔ∏è',
                'Others': '‚≠ê'
            };

            const emoji = categoryEmojis[categoryInput] || '‚≠ê';

            // Check if name already starts with an emoji (broader regex to catch all emojis)
            const emojiRegex = /^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F900}-\u{1F9FF}]/u;
            const startsWithEmoji = emojiRegex.test(currentName);

            if (!startsWithEmoji) {
                // Add category emoji at the beginning
                nameField.value = emoji + ' ' + currentName;
                console.log('‚ú® Added category emoji:', emoji);
            } else {
                console.log('‚úÖ Activity name already has emoji');
            }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const data = { days: {} };

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const fields = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                fields.push(current.trim());

                // Now CSV has: Date, DayNumber, DayTitle, ActivityName, ActivityDetails, Cost, Link, Category, Location, Time
                const [dateStr, dayNumber, dayTitle, activityName, activityDetails, cost, link, category, location, time] = fields;

                if (!dayNumber || !dateStr) continue;

                // Parse the actual date from CSV
                const parsedDate = new Date(dateStr + 'T12:00:00');
                const dateKey = dateStr; // Use date as unique key instead of dayNumber

                if (!data.days[dateKey]) {
                    data.days[dateKey] = {
                        dayNumber: dayNumber,
                        dayTitle: dayTitle || dayNumber,
                        date: parsedDate,
                        dateStr: dateStr,
                        sortKey: parsedDate.getTime(),
                        activities: []
                    };
                }

                if (activityName) {
                    data.days[dateKey].activities.push({
                        name: activityName,
                        details: activityDetails || '',
                        cost: cost || '',
                        link: link || '',
                        category: category || 'Others',
                        location: location || '',
                        time: time || ''
                    });
                }
            }

            // Sort days by date
            const sortedDays = Object.values(data.days).sort((a, b) => a.sortKey - b.sortKey);

            // Sort activities by time within each day
            sortedDays.forEach(day => {
                day.activities.sort((a, b) => {
                    if (!a.time && !b.time) return 0;
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });
            });

            return { days: sortedDays };
        }

        async function loadFromSheets(forceRefresh = false) {
            const errorDiv = document.getElementById('errorMessage');

            // Skip auto-refresh if item was added in the last 60 seconds
            // (CSV takes time to publish, don't overwrite fresh additions)
            if (!forceRefresh && lastAddedTime) {
                const timeSinceAdd = (Date.now() - lastAddedTime) / 1000;
                if (timeSinceAdd < 60) {
                    console.log('‚è≠Ô∏è Skipping auto-refresh (item added ' + Math.floor(timeSinceAdd) + 's ago)');
                    return;
                }
            }

            errorDiv.innerHTML = '';

            try {
                // Add cache-busting parameter
                const cacheBuster = '&_=' + Date.now();
                const response = await fetch(SHEET_CSV_URL + cacheBuster);
                if (!response.ok) throw new Error('Failed to load data');

                const csvData = await response.text();
                const newData = parseCSV(csvData);

                // Update trip data
                tripData = newData;
                lastUpdate = new Date();

                render();
                updateSyncStatus();

                // Save to cache
                localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));
                localStorage.setItem('orlandoTripLastUpdate', lastUpdate.toISOString());

                // Show success feedback for manual refreshes
                if (forceRefresh) {
                    errorDiv.innerHTML = '<div class="success-message">‚úÖ Synced with Google Sheets!</div>';
                    setTimeout(() => {
                        errorDiv.innerHTML = '';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error loading from sheets:', error);

                const cached = localStorage.getItem('orlandoTripCache');
                if (cached) {
                    tripData = JSON.parse(cached);
                    const cachedUpdate = localStorage.getItem('orlandoTripLastUpdate');
                    lastUpdate = cachedUpdate ? new Date(cachedUpdate) : null;
                    render();
                    updateSyncStatus();
                    errorDiv.innerHTML = '<div class="error-message">üì° Offline - showing cached data</div>';
                } else {
                    errorDiv.innerHTML = '<div class="error-message">‚ùå Could not load data</div>';
                }
            }
        }

        function calculateTotal() {
            let total = 0;
            tripData.days.forEach(day => {
                day.activities.forEach(activity => {
                    if (activity.cost) {
                        // Remove any non-numeric characters except decimal point
                        const cleanCost = String(activity.cost).replace(/[^0-9.]/g, '');
                        const costNum = parseFloat(cleanCost);
                        if (!isNaN(costNum) && costNum > 0) {
                            total += costNum;
                        }
                    }
                });
            });
            return total;
        }

        function updateTotal() {
            const total = calculateTotal();
            document.getElementById('totalBudget').innerHTML = `$${total.toFixed(2)}`;
        }

        function getCategoryTotals() {
            const categoryColors = {
                'Parks': '#8b5cf6',
                'Food': '#f59e0b',
                'Hotels': '#10b981',
                'Car': '#3b82f6',
                'Flights': '#ef4444',
                'Shopping': '#ec4899',
                'Others': '#6b7280'
            };

            const totals = {};

            tripData.days.forEach(day => {
                day.activities.forEach(activity => {
                    const category = activity.category || 'Others';
                    if (activity.cost) {
                        const cleanCost = String(activity.cost).replace(/[^0-9.]/g, '');
                        const costNum = parseFloat(cleanCost);
                        if (!isNaN(costNum) && costNum > 0) {
                            totals[category] = (totals[category] || 0) + costNum;
                        }
                    }
                });
            });

            return Object.entries(totals)
                .map(([category, amount]) => ({
                    category,
                    amount,
                    color: categoryColors[category] || '#6b7280'
                }))
                .sort((a, b) => b.amount - a.amount);
        }

        function drawPieChart() {
            const canvas = document.getElementById('pieChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const categoryData = getCategoryTotals();

            if (categoryData.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const total = categoryData.reduce((sum, item) => sum + item.amount, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;

            let startAngle = -Math.PI / 2;

            categoryData.forEach(item => {
                const sliceAngle = (item.amount / total) * 2 * Math.PI;

                // Draw slice
                ctx.fillStyle = item.color;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();

                // Add subtle border
                ctx.strokeStyle = '#1e1e2e';
                ctx.lineWidth = 2;
                ctx.stroke();

                startAngle += sliceAngle;
            });

            // Update legend
            const legendHTML = categoryData.map(item => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${item.color}"></div>
                    <div class="legend-label">${item.category}</div>
                    <div class="legend-amount">$${item.amount.toFixed(2)}</div>
                </div>
            `).join('');

            document.getElementById('chartLegend').innerHTML = legendHTML;
        }

        function updateNextActivity() {
            // Get current Orlando time (GMT-4)
            const now = new Date();
            const orlandoNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const nowStr = orlandoNow.toISOString().split('T')[0];
            const nowTime = orlandoNow.toTimeString().slice(0, 5); // HH:MM format

            let nextActivity = null;

            // Find next activity based on date AND time
            for (const day of tripData.days) {
                if (day.dateStr > nowStr || (day.dateStr === nowStr && day.activities.length > 0)) {
                    // Sort activities by time
                    const sortedActivities = [...day.activities].sort((a, b) => {
                        if (!a.time && !b.time) return 0;
                        if (!a.time) return 1;
                        if (!b.time) return -1;
                        return a.time.localeCompare(b.time);
                    });

                    // If it's today, find the next activity by time
                    if (day.dateStr === nowStr) {
                        const futureActivity = sortedActivities.find(act => act.time && act.time > nowTime);
                        if (futureActivity) {
                            nextActivity = {
                                name: futureActivity.name,
                                time: futureActivity.time,
                                dateStr: day.dateStr,
                                dayTitle: day.dayTitle
                            };
                            break;
                        }
                    } else {
                        // Future day - take first activity
                        nextActivity = {
                            name: sortedActivities[0].name,
                            time: sortedActivities[0].time,
                            dateStr: day.dateStr,
                            dayTitle: day.dayTitle
                        };
                        break;
                    }
                }
            }

            if (nextActivity) {
                document.getElementById('nextActivityName').textContent = nextActivity.name;
                const isToday = nextActivity.dateStr === nowStr;

                let dateLabel;
                if (isToday) {
                    dateLabel = 'Today';
                } else {
                    const dateObj = new Date(nextActivity.dateStr + 'T12:00:00');
                    dateLabel = dateObj.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                }

                const timeStr = nextActivity.time ? ` at ${nextActivity.time}` : '';
                document.getElementById('nextActivityTime').textContent = `${dateLabel}${timeStr}`;
            } else {
                document.getElementById('nextActivityName').textContent = 'All activities completed! üéâ';
                document.getElementById('nextActivityTime').textContent = 'Enjoy your memories!';
            }
        }

        function updateSyncStatus() {
            const statusDiv = document.getElementById('syncStatus');
            if (lastUpdate) {
                const now = new Date();
                const diff = Math.floor((now - lastUpdate) / 1000);

                if (diff < 60) {
                    statusDiv.textContent = 'Last synced: Just now';
                } else if (diff < 3600) {
                    statusDiv.textContent = `Last synced: ${Math.floor(diff / 60)} min ago`;
                } else {
                    statusDiv.textContent = `Last synced: ${lastUpdate.toLocaleTimeString()}`;
                }
            }
        }

        function toggleDay(dayIndex) {
            const daySection = document.querySelector(`.day-section[data-day="${dayIndex}"]`);
            daySection.classList.toggle('collapsed');
        }

        function toggleMenu(menuId, event) {
            event.stopPropagation();
            const menu = document.getElementById(menuId);

            // Close all other menus
            document.querySelectorAll('.menu-dropdown.active').forEach(m => {
                if (m.id !== menuId) m.classList.remove('active');
            });

            menu.classList.toggle('active');
        }

        function editActivity(dayIndex, activityIndex) {
            const day = tripData.days[dayIndex];
            const activity = day.activities[activityIndex];

            // Populate the form with existing data
            document.getElementById('addDate').value = day.dateStr;
            document.getElementById('addTime').value = activity.time || '';
            document.getElementById('addDayTitle').value = day.dayTitle || '';
            document.getElementById('addName').value = activity.name;
            document.getElementById('addCategory').value = activity.category || '';
            document.getElementById('addDetails').value = activity.details || '';
            document.getElementById('addCost').value = activity.cost || '';
            document.getElementById('addLink').value = activity.link || '';
            document.getElementById('addLocation').value = activity.location || '';

            // Store the edit info for later - including original name for finding in Sheets
            window.editingActivity = {
                dayIndex,
                activityIndex,
                originalName: activity.name,
                originalDateStr: day.dateStr
            };

            // Change modal title and button text
            document.querySelector('.modal-header').innerHTML = '‚úèÔ∏è Edit Expense';
            document.getElementById('saveButton').textContent = 'Update & Sync';

            // Open modal
            document.getElementById('addModal').classList.add('active');

            // Close menu
            closeAllMenus();
        }

        async function deleteActivity(dayIndex, activityIndex) {
            const day = tripData.days[dayIndex];
            const activity = day.activities[activityIndex];

            if (confirm(`Delete "${activity.name}"?`)) {
                // Close menu first
                closeAllMenus();

                // Show loading overlay
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('active');

                // Sync deletion to Google Sheets
                try {
                    const payload = {
                        action: 'delete',
                        dateStr: day.dateStr,
                        name: activity.name
                    };

                    console.log('üì§ Deleting from Sheets:', payload);

                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    console.log('‚úÖ Activity deleted from Google Sheets');
                } catch (error) {
                    console.error('Failed to delete activity:', error);
                }

                // Remove from local data
                tripData.days[dayIndex].activities.splice(activityIndex, 1);

                // If day has no activities, remove the day
                if (tripData.days[dayIndex].activities.length === 0) {
                    tripData.days.splice(dayIndex, 1);
                }

                // Update cache
                localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));

                // Re-render
                render();

                // Show success message
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.innerHTML = '<div class="success-message">‚úÖ Deleted & synced!</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);

                overlay.classList.remove('active');
            } else {
                closeAllMenus();
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.menu-dropdown.active').forEach(m => {
                m.classList.remove('active');
            });
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.activity-menu')) {
                closeAllMenus();
            }
        });

        function render() {
            const content = document.getElementById('tripContent');
            content.innerHTML = '';

            if (!tripData.days || tripData.days.length === 0) {
                content.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No trip data available</div>';
                return;
            }

            // Get today's date (in same timezone)
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD

            tripData.days.forEach((day, dayIndex) => {
                const daySection = document.createElement('div');
                daySection.className = 'day-section';
                daySection.setAttribute('data-day', dayIndex);

                // Collapse by default, except if it's today
                const isToday = day.dateStr === todayStr;
                if (!isToday) {
                    daySection.classList.add('collapsed');
                }

                // Sort activities by time before rendering
                day.activities.sort((a, b) => {
                    if (!a.time && !b.time) return 0;
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });

                let activitiesHTML = '';
                day.activities.forEach((activity, activityIndex) => {
                    // Format cost safely
                    let costHTML = '';
                    if (activity.cost) {
                        const cleanCost = String(activity.cost).replace(/[^0-9.]/g, '');
                        const costNum = parseFloat(cleanCost);
                        if (!isNaN(costNum) && costNum > 0) {
                            costHTML = `<div class="cost">$${costNum.toFixed(2)}</div>`;
                        }
                    }

                    const menuId = `menu-${dayIndex}-${activityIndex}`;

                    // Create directions buttons if location exists
                    let directionsHTML = '';
                    if (activity.location) {
                        const escapedLocation = activity.location.replace(/'/g, "\\'");
                        directionsHTML = `
                            <div class="directions-buttons">
                                <button class="directions-btn google" onclick="openGoogleMaps('${escapedLocation}')">
                                    üìç Maps
                                </button>
                                <button class="directions-btn waze" onclick="openWaze('${escapedLocation}')">
                                    üöó Waze
                                </button>
                            </div>
                        `;
                    }

                    // Format time if available
                    let timeHTML = '';
                    if (activity.time) {
                        timeHTML = `<div style="font-size: 12px; color: #a78bfa; margin-top: 4px; font-weight: 600;">üïê ${activity.time}</div>`;
                    }

                    activitiesHTML += `
                        <div class="activity" data-day="${dayIndex}" data-activity="${activityIndex}">
                            <div class="activity-header">
                                <div class="activity-name">${activity.name}</div>
                                <div class="activity-menu">
                                    <button class="menu-btn" onclick="toggleMenu('${menuId}', event)">‚ãÆ</button>
                                    <div class="menu-dropdown" id="${menuId}">
                                        <div class="menu-item" onclick="editActivity(${dayIndex}, ${activityIndex})">
                                            ‚úèÔ∏è Edit
                                        </div>
                                        <div class="menu-item delete" onclick="deleteActivity(${dayIndex}, ${activityIndex})">
                                            üóëÔ∏è Delete
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ${timeHTML}
                            ${activity.details ? `<div class="activity-details">${activity.details}</div>` : ''}
                            ${costHTML}
                            ${activity.link ? `<a href="${activity.link}" class="link" target="_blank">Link ‚Üí</a>` : ''}
                            ${directionsHTML}
                        </div>
                    `;
                });

                // Get weekday
                const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const dateObj = day.date instanceof Date ? day.date : new Date(day.date);
                const weekday = weekdays[dateObj.getDay()];

                daySection.innerHTML = `
                    <div class="day-header" onclick="toggleDay(${dayIndex})">
                        <div class="day-number">
                            ${day.dayNumber}
                            <div class="weekday-label">${weekday}</div>
                        </div>
                        <span style="flex: 1; margin-left: 15px;">${day.dayTitle}${isToday ? ' üìç' : ''}</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="activities">
                        ${activitiesHTML}
                    </div>
                `;

                content.appendChild(daySection);
            });

            updateTotal();
            drawPieChart();
            updateNextActivity();
        }

        function openAddModalSmart() {
            if (currentView === 'checklist') {
                openChecklistModal();
            } else {
                openAddModal();
            }
        }

        function openAddModal() {
            // Reset editing state
            window.editingActivity = null;

            // Reset modal title and button
            document.querySelector('.modal-header').innerHTML = '‚ûï Add Expense';
            document.getElementById('saveButton').textContent = 'Add & Sync';

            // Set default date to today or first trip date
            const today = new Date();
            const tripStart = new Date(2025, 9, 30); // Oct 30, 2025
            const tripEnd = new Date(2025, 10, 9);   // Nov 9, 2025

            let defaultDate = today;
            if (today < tripStart) defaultDate = tripStart;
            if (today > tripEnd) defaultDate = tripStart;

            const dateStr = defaultDate.toISOString().split('T')[0];
            document.getElementById('addDate').value = dateStr;

            // Clear all fields
            document.getElementById('addTime').value = '';
            document.getElementById('addDayTitle').value = '';
            document.getElementById('addName').value = '';
            document.getElementById('addCategory').value = '';
            document.getElementById('addDetails').value = '';
            document.getElementById('addCost').value = '';
            document.getElementById('addLink').value = '';
            document.getElementById('addLocation').value = '';

            // Auto-fill day title for the default date
            autoFillDayTitle();

            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            window.editingActivity = null;

            // Reset modal title and button
            document.querySelector('.modal-header').innerHTML = '‚ûï Add Expense';
            document.getElementById('saveButton').textContent = 'Add & Sync';
        }

        function addItemToLocalData(data) {
            // Find or create the day in local data using dateStr
            let dayData = tripData.days.find(d => d.dateStr === data.dateStr);

            if (!dayData) {
                // Create new day if it doesn't exist
                dayData = {
                    dayNumber: data.dayNumber,
                    dayTitle: data.dayTitle,
                    date: new Date(data.dateObj),
                    dateStr: data.dateStr,
                    sortKey: data.dateObj.getTime(),
                    activities: []
                };
                tripData.days.push(dayData);
                // Sort days by date
                tripData.days.sort((a, b) => a.sortKey - b.sortKey);
            }

            // Add the new activity
            dayData.activities.push({
                name: data.name,
                category: data.category || 'Others',
                details: data.details || '',
                cost: data.cost || '',
                link: data.link || '',
                location: data.location || '',
                time: data.time || ''
            });

            // Sort activities by time within the day
            dayData.activities.sort((a, b) => {
                if (!a.time && !b.time) return 0;
                if (!a.time) return 1;
                if (!b.time) return -1;
                return a.time.localeCompare(b.time);
            });

            // Update cache
            localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));
        }

        async function saveToGoogleSheets() {
            const errorDiv = document.getElementById('errorMessage');
            const saveBtn = document.getElementById('saveButton');
            const overlay = document.getElementById('loadingOverlay');

            // Check if Apps Script URL is configured
            if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                errorDiv.innerHTML = '<div class="error-message">‚ö†Ô∏è Please configure your Apps Script URL first!</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
                return;
            }

            // Read ALL form values
            const dateInput = document.getElementById('addDate').value;
            const timeInput = document.getElementById('addTime').value;
            const dayTitleInput = document.getElementById('addDayTitle').value.trim();
            const nameInput = document.getElementById('addName').value.trim();
            const categoryInput = document.getElementById('addCategory').value;
            const detailsInput = document.getElementById('addDetails').value.trim();
            const costInput = document.getElementById('addCost').value.trim().replace(',', '.');  // Convert comma to period for decimals
            const linkInput = document.getElementById('addLink').value.trim();
            const locationInput = document.getElementById('addLocation').value.trim();

            // CRITICAL DEBUG - Check form inputs
            console.log('üîç FORM INPUTS READ:');
            console.log('dateInput:', dateInput, '(type:', typeof dateInput, ')');
            console.log('timeInput:', timeInput);
            console.log('dayTitleInput:', dayTitleInput);
            console.log('nameInput:', nameInput);
            console.log('categoryInput:', categoryInput);
            console.log('locationInput:', locationInput);

            if (!dateInput || !nameInput) {
                errorDiv.innerHTML = '<div class="error-message">‚ö†Ô∏è Please fill in Date and Activity Name</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
                return;
            }

            // Parse the date (format: YYYY-MM-DD from date picker)
            const dateObj = new Date(dateInput + 'T12:00:00');
            const day = dateObj.getDate();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthFull = monthNames[dateObj.getMonth()];

            // CRITICAL: Calculate day number from the date
            const calculatedDayNumber = day.toString();

            // CRITICAL: Determine final day title
            let finalDayTitle = '';
            if (dayTitleInput && dayTitleInput !== '') {
                // User provided a day title
                finalDayTitle = dayTitleInput;
            } else {
                // Auto-generate or use existing
                const existingDay = tripData.days.find(d => d.dayNumber === calculatedDayNumber);
                if (existingDay) {
                    finalDayTitle = existingDay.dayTitle;
                } else {
                    finalDayTitle = `Trip Day - ${monthFull} ${day}`;
                }
            }

            // Create data object with EXACT field names that Apps Script expects
            const data = {
                dateStr: dateInput,                       // A: Date (YYYY-MM-DD)
                dayNumber: calculatedDayNumber,           // B: DayNumber
                dayTitle: finalDayTitle,                  // C: DayTitle
                name: nameInput,                          // D: ActivityName
                details: detailsInput,                    // E: ActivityDetails
                cost: costInput,                          // F: Cost
                link: linkInput,                          // G: Link
                category: categoryInput || 'Others',      // H: Category
                location: locationInput,                  // I: Location
                time: timeInput,                          // J: Time (HH:MM)
                dateObj: dateObj                          // For local use only
            };

            // DETAILED DEBUG LOGGING
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç DATA TO GOOGLE SHEETS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('Column A (Date):', data.dateStr);
            console.log('Column B (DayNumber):', data.dayNumber);
            console.log('Column C (DayTitle):', data.dayTitle);
            console.log('Column D (ActivityName):', data.name);
            console.log('Column E (ActivityDetails):', data.details);
            console.log('Column F (Cost):', data.cost);
            console.log('Column G (Link):', data.link);
            console.log('Column H (Category):', data.category);
            console.log('Column I (Location):', data.location);
            console.log('Column J (Time):', data.time);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            // Validate required fields
            if (!data.dateStr || !data.dayNumber || !data.name) {
                console.error('‚ùå ERROR: Missing required fields!');
                console.error('dateStr:', data.dateStr);
                console.error('dayNumber:', data.dayNumber);
                console.error('name:', data.name);
                errorDiv.innerHTML = '<div class="error-message">‚ùå Error: Missing required data. Check console.</div>';
                setTimeout(() => errorDiv.innerHTML = '', 3000);
                saveBtn.disabled = false;
                overlay.classList.remove('active');
                return;
            }

            saveBtn.disabled = true;
            overlay.classList.add('active');
            errorDiv.innerHTML = '';

            // Check if we're editing
            if (window.editingActivity) {
                const { dayIndex, activityIndex, originalName, originalDateStr } = window.editingActivity;
                const day = tripData.days[dayIndex];

                // Sync update to Google Sheets
                try {
                    const payload = {
                        action: 'update',
                        dateStr: dateInput,            // NEW date value
                        originalDateStr: originalDateStr,  // Original date to find the row
                        oldName: originalName,         // Original name to find the row
                        dayNumber: calculatedDayNumber,
                        dayTitle: finalDayTitle,
                        name: nameInput,
                        details: detailsInput,
                        cost: costInput,
                        link: linkInput,
                        category: categoryInput || 'Others',
                        location: locationInput,
                        time: timeInput
                    };

                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('üì§ UPDATING ACTIVITY IN SHEETS');
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('Original Date:', originalDateStr);
                    console.log('Original Name:', originalName);
                    console.log('New Date:', dateInput);
                    console.log('New Name:', nameInput);
                    console.log('New Cost:', costInput);
                    console.log('Full Payload:', JSON.stringify(payload, null, 2));
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    console.log('‚úÖ Activity update request sent to Google Sheets');
                    console.log('‚è≥ Check Apps Script Executions to see if it was found and updated');
                } catch (error) {
                    console.error('‚ùå Failed to update activity:', error);
                }

                // Update local data
                tripData.days[dayIndex].activities[activityIndex] = {
                    name: nameInput,
                    category: categoryInput || 'Others',
                    details: detailsInput,
                    cost: costInput,
                    link: linkInput,
                    location: locationInput,
                    time: timeInput
                };

                // Update cache
                localStorage.setItem('orlandoTripCache', JSON.stringify(tripData));

                // Close modal first
                closeAddModal();

                // Re-render
                render();

                // Show success message
                errorDiv.innerHTML = '<div class="success-message">‚úÖ Updated & synced! Fernanda will see changes.</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);

                saveBtn.disabled = false;
                overlay.classList.remove('active');
                return;
            }

            try {
                // Create a completely fresh object to send to Google Sheets
                // Use explicit values, not references
                const payload = {
                    dateStr: String(dateInput),
                    dayNumber: String(calculatedDayNumber),
                    dayTitle: String(finalDayTitle),
                    name: String(nameInput),
                    details: String(detailsInput),
                    cost: String(costInput),
                    link: String(linkInput),
                    category: String(categoryInput || 'Others'),
                    location: String(locationInput),
                    time: String(timeInput)
                };

                // Log everything
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üì§ PAYLOAD TO GOOGLE SHEETS:');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('1. dateStr:', payload.dateStr);
                console.log('2. dayNumber:', payload.dayNumber);
                console.log('3. dayTitle:', payload.dayTitle);
                console.log('4. name:', payload.name);
                console.log('5. details:', payload.details);
                console.log('6. cost:', payload.cost);
                console.log('7. link:', payload.link);
                console.log('8. category:', payload.category);
                console.log('9. location:', payload.location);
                console.log('10. time:', payload.time);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('JSON:', JSON.stringify(payload));
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                // Close modal immediately
                closeAddModal();

                // Show success message with helpful tip
                errorDiv.innerHTML = '<div class="success-message">‚úÖ Saved! Item added to your list.<br><small style="opacity: 0.9; font-size: 12px;">Tap üîÑ in 15-30 sec to sync with Google Sheets</small></div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 4000);

                // Add the item to local data immediately for instant feedback
                // Use the same payload structure
                const localData = {
                    ...payload,
                    dateObj: dateObj
                };
                addItemToLocalData(localData);
                render();

                // Mark that we just added an item
                lastAddedTime = Date.now();

                // DON'T auto-refresh - let the 2-minute interval handle it
                // Google Sheets CSV takes 10-30 seconds to update anyway
                // The 2-minute auto-refresh will catch it later
                // Auto-refresh is also blocked for 60 seconds after adding

            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                closeAddModal();
                errorDiv.innerHTML = '<div class="error-message">‚ùå Failed to save. Check your connection.</div>';
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
            } finally {
                saveBtn.disabled = false;
                overlay.classList.remove('active');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('üöÄ Orlando Trip App Starting...');

            // Initialize pull-to-refresh
            initPullToRefresh();
            console.log('‚úÖ Pull-to-refresh enabled');

            // Start Orlando clock
            updateOrlandoClock();
            setInterval(updateOrlandoClock, 1000); // Update every second

            // Load cached trip data
            const cached = localStorage.getItem('orlandoTripCache');
            if (cached) {
                tripData = JSON.parse(cached);
                const cachedUpdate = localStorage.getItem('orlandoTripLastUpdate');
                lastUpdate = cachedUpdate ? new Date(cachedUpdate) : null;
                render();
                updateSyncStatus();
            }

            // Auto-load activities from Google Sheets
            console.log('üì• Loading activities from Google Sheets...');
            loadFromSheets();

            // Auto-refresh activities every 2 minutes
            setInterval(() => {
                if (currentView === 'activities') {
                    loadFromSheets();
                }
            }, 2 * 60 * 1000);

            // Update sync status every minute
            setInterval(updateSyncStatus, 60000);

            // Update Next Activity every minute (in case time has passed)
            setInterval(updateNextActivity, 60000);
        });
    </script>
</body>
</html>
